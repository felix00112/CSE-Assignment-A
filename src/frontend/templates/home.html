{{ define "home" }}

{{ template "header" . }}
<div {{ with $.platform_css }} class="{{.}}" {{ end }}>
  <span class="platform-flag">{{$.platform_name}}</span>
</div>

<main role="main" class="home">
  <!-- Wishlist Dropdown -->
  <div class="wishlist-container" style="margin: 20px 0;">
    <button class="wishlist-button">
      Wishlists
      <div class="triangle"></div>
    </button>
    <div class="dropdown">
      <div class="dropdown-header">
        <span>Wishlists</span>
        <button class="add-button">+</button>
      </div>
      <div class="dropdown-list"></div>
    </div>
  </div>

  <!-- Section for hot products -->
  <div class="container-fluid">
    <div class="row hot-products-row px-xl-6">
      {{ range $.products }}
      <div class="col-md-4 hot-product-card">
        <a href="{{ $.baseUrl }}/product/{{.Item.Id}}">
          <img loading="lazy" src="{{ $.baseUrl }}{{.Item.Picture}}">
        </a>
        <div>
          <div class="hot-product-card-name">{{ .Item.Name }}</div>
          <div class="hot-product-card-price">{{ renderMoney .Price }}</div>
          <!-- Add to Wishlist Button -->
          <div class="dynamic-wishlist-button" style="margin-top: 10px;">
            <div class="container" style="position: relative;">
              <button class="wishlist-toggle-button" data-product-id="{{ .Item.Id }}">
                ♥ Add to Wishlist
              </button>
              <div class="dropdown">
                <div class="dropdown-list"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {{ end }}
    </div>
  </div>
</main>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const wishlistButton = document.querySelector(".wishlist-button");
    const dropdown = document.querySelector(".dropdown");
    const dropdownList = document.querySelector(".dropdown-list");
    const addButton = document.querySelector(".add-button");
    const toggleButtons = document.querySelectorAll(".wishlist-toggle-button");

    let wishlists = JSON.parse(localStorage.getItem("wishlists")) || ["My Wishlist"];
    let productWishlists = JSON.parse(localStorage.getItem("productWishlists")) || {};

    // Wishlist Dropdown Logic
    function renderDropdown() {
      dropdownList.innerHTML = "";
      wishlists.forEach(name => {
        const item = document.createElement("div");
        item.className = "dropdown-item";
        item.innerHTML = `
          <span>${name}</span>
          ${name !== "My Wishlist" ? `
            <button class="menu-button">⋮</button>
            <div class="menu-options">
              <div class="menu-rename">Rename</div>
              <div class="menu-delete">Delete</div>
            </div>` : ''}
        `;
        attachMenuEvents(item, name);
        dropdownList.appendChild(item);
      });
    }

    function attachMenuEvents(item, name) {
      const menuButton = item.querySelector(".menu-button");
      const menuOptions = item.querySelector(".menu-options");

      menuButton?.addEventListener("click", (e) => {
        e.stopPropagation();
        menuOptions.classList.toggle("active");
      });

      menuOptions?.querySelector(".menu-rename")?.addEventListener("click", () => {
        const newName = prompt("Rename wishlist:", name);
        if (newName && !wishlists.includes(newName)) {
          wishlists[wishlists.indexOf(name)] = newName;
          updateLocalStorage();
          renderDropdown();
        }
      });

      menuOptions?.querySelector(".menu-delete")?.addEventListener("click", () => {
        if (confirm(`Delete wishlist "${name}"?`)) {
          wishlists = wishlists.filter(w => w !== name);
          updateLocalStorage();
          renderDropdown();
        }
      });
    }

    function updateLocalStorage() {
      localStorage.setItem("wishlists", JSON.stringify(wishlists));
      localStorage.setItem("productWishlists", JSON.stringify(productWishlists));
    }

    wishlistButton.addEventListener("click", () => {
      dropdown.classList.toggle("active");
      renderDropdown();
    });

    addButton.addEventListener("click", () => {
      const newWishlist = prompt("Enter a new wishlist name:");
      if (newWishlist && !wishlists.includes(newWishlist)) {
        wishlists.push(newWishlist);
        updateLocalStorage();
        renderDropdown();
      }
    });

    // Add to Wishlist Logic
    toggleButtons.forEach(button => {
      const productId = button.dataset.productId;
      button.addEventListener("click", () => {
        const dropdown = button.nextElementSibling;
        dropdown.classList.toggle("active");
        populateProductDropdown(dropdown, productId, button);
      });

      // Check initial state of the button
      updateButtonState(productId, button);
    });

    function populateProductDropdown(dropdown, productId, button) {
      dropdown.innerHTML = "";
      wishlists.forEach(wishlist => {
        const isAdded = productWishlists[productId]?.includes(wishlist) || false;
        const item = document.createElement("div");
        item.className = "dropdown-item";
        item.innerHTML = `
          <span>${wishlist}</span>
          <button class="toggle-button">${isAdded ? "−" : "+"}</button>
        `;

        const toggleButton = item.querySelector(".toggle-button");
        toggleButton.addEventListener("click", () => {
          productWishlists[productId] = productWishlists[productId] || [];
          if (isAdded) {
            productWishlists[productId] = productWishlists[productId].filter(w => w !== wishlist);
            toggleButton.textContent = "+";
          } else {
            productWishlists[productId].push(wishlist);
            toggleButton.textContent = "−";
          }
          updateLocalStorage();
          updateButtonState(productId, button);
        });

        dropdown.appendChild(item);
      });
    }

    function updateButtonState(productId, button) {
      const isAdded = productWishlists[productId]?.length > 0;
      button.textContent = isAdded ? "- Remove from Wishlist" : "♥ Add to Wishlist";
    }

    renderDropdown();
  });
</script>

{{ template "footer" . }}
{{ end }}
